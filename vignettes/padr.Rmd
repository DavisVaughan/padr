---
title: "Using padr for preparing data that contain datetime variables"
author: "Edwn Thoen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Working with dates and times

Raw data containing date and time variables are often not in a for that allows for direct analysis. Getting the data in the correct form can be somewhat tedious, even when using packages that allow for powerful data transformation like `data.table` and `dplyr`. The `padr` package aims to take away a part of the hassle of date and time variables cleaning. Its core consists of two functions `pad` and `thicken` that do some heavy lifting when going from raw data to an analyssi set.

## Interval

The interval of the data in the context of `padr` is the recurrence of observations in a date or time variable. It can be thought of as the heartbeat of the data, at each pulse we have an observation. The interval is "year" when we have an observation each year, "month" when there is an observation each month etc.[^1]

[^1]: Many users that work with date and time variables will be working with the `lubridate` package. The definition of an interval in `lubridate` is different from the definition in `padr`. In `lubridate` an interval is a period between two time points and has nothing to do with recurrence. Please keep this in mind.

Be aware that the interval of the data is only concerned with the recurrence of the data, you can have a monthy observation at any point in time within the month as long as it recurs at the exact same moment each month. A second thing to note here is that the interval definition does not require that there is an observation at each and every time point where the could be an observation. It is the highest time unit in the hierarchy that can explain all of the observations. `padr` comes with the `get_interval` function to test of what interval a date time variable is.

```{r}
devtools::load_all()
monthly <- seq(as.Date('2016-01-01'), length.out = 12, by ='month')
get_interval(monthly)
get_interval(monthly[c(1, 3, 4, 7, 9, 11, 12)])
```


Now we have the definition of interval straight we can start doing some useful stuff with it. First of all we can recognize where observations are missing and `pad` them to return a complete time series.

```{r}
library(dplyr)
monthly[c(1, 3, 4, 7, 9, 11, 12)] %>% pad
```

So `pad` recognizes the interval, sees where observations in the time series are missing and returns the padded time series the first observation in the input up untill the last observation in the input. `pad` als works on an entire data frame, where it will recognize the date time variable, pad it and inserts `NA` values for all other columns of the padded observations. Say I want to do a plot of the balance of my bank acount but I only have a record on days I did a transaction. Combining `pad` with `fill` from the `tidyr` package I can easily create this plot in a correct way.

```{r}
library(ggplot2)
set.seed(42)
ind <- c(1,4,6,11,17,19,20,21,25,28,31)
balance <- data.frame(day = seq(as.Date('2016-01-01'), length.out = 31, by = 'day')[ind],
                      bal = runif(length(ind), 1000, 2000) %>% round(2) )
ggplot(balance, aes(day, bal)) + geom_line() + geom_point()
balance_padded <- balance %>% pad %>% tidyr::fill(bal)
ggplot(balance_padded, aes(day, bal)) + geom_line() + geom_point()
```

In the default mode `pad` takes care of the tedious work of padding a date time variable. However one can deviate from it in a number of way. First of all the desired start value and / or end value might not be present in the input variable. A `start_val` and an `end_val` can be specified manually. Furthermore one might to pad the data with an interval that is lower than the interval of the data. Also this can be specified with the argument `interval`.

```{r}
x <- data.frame(d    = as.Date( c('2016-04-16', '2016-04-17')),
                val  = c(14, 42))

x <- x$d
pad(x, interval = 'hour')
pad(x, 
    start_val = as.POSIXct('2016-03-16 23:00:00')) 
    # end_val = as.POSIXct('2016-05-16 01:00:00'),
    # interval = 'hour')
```


A second problem that `padr` aims to solve is data that is that raw date time variables can be of too low an interval. We might want to analyze time series data at a more aggregated level. `thicken` takes a date time variable, determines its interval and returns a date time variable of the same length of a higher interval. The result of `thicken` can subsequently be used to aggregate the data. By default `thicken` will return a variable with the interval being one interval higher than that of the input variable.

```{r}
thicken(monthly)[,2] %>% get_interval
```

In combination with `dplyr` we can have our date aggregated to the correct interval in no time.

```{r}
emergency %>% 
  filter(title == 'EMS: CARDIAC ARREST') %>% 
  thicken('month', colname = 'month') %>%  
  group_by(month)%>% 
  summarise(nr = n()) %>% 
  ggplot(aes(month, nr)) + geom_line()
```

Thicken spans a vector of a higher interval around the input variable and subsequently maps each value of the input variable to the closest thickened value. This can be either to the closest value that is smaller (rounding = down) or larger (rounding = up) than the input value.

