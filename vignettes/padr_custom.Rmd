---
title: "Custom thickening and padding"
author: "Edwn Thoen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Custom thickening and padding}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette assumes the reader has read the [Introduction to `padr` vignette](link). These functions are introduced in version 0.4.0 of the package and should be considered still experimental.

The base function `thicken` creates evenly spaced intervals to which observations can be aggregated. `pad` subsequently checks for missing observations and inserts records where needed. This procedure can be largely automated because of the assumption of an evenly spaced interval. However, the functions can't deliver when assymetry in the intervals is desired. This might happen when observations are frequent during some moments, and sparse during others. For instance daily hours vs night periods, or working days vs weekends. We might want to perform a single analysis where the intervals are of different widths. 

Lets have a look at all the vehicle incidents in the `emergency` dataset. Say you want to monitor the trends of number of accidents in the second quarter of 2016. You choose a three hour interval to do the analysis.

```{r, fig.width = 7}
# library(padr)
devtools::load_all()
library(tidyverse)
veh_acc <- emergency %>% 
  filter(title == "Traffic: VEHICLE ACCIDENT -",
         lubridate::month(time_stamp) %in% 4:6) 

facetted_line_plot <- function(padded_df) {
  padded_df %>% 
  fill_by_value() %>% 
  thicken("day", "day") %>% 
  mutate(interval = format_start_end(day_hour, "%H", sep = "-" )) %>% 
  ggplot(aes(day, n)) + 
  facet_wrap(~interval) +
  geom_line() 
}

veh_acc %>%
  thicken("3 hour", "day_hour") %>% 
  count(day_hour) %>% 
  pad() %>% 
  facetted_line_plot()
```

Accidents are more common around rush hours. During nightly hours there are hardly any accidents, and also in the daytime the number drops slightly. We would rather aggregate this to morning rush hour, day time, evening rush hour, and night time.

## Preparing the spanning

`thicken`'s internal work horse is a spanning function. It takes the datetime variable and spans a datetime variable of the desired interval around it. When you want your own asymmetric intervals, you have to build the spanning variable yourself. To help you with that the functions `span_around` and `subset_span` are provided. `span_around` is a wrapper around the internal `span` function. It will return a spanning with an evenly spaced interval. The result of `span_around` is fed to `subset_span`. Here you define the assymetric pattern you are after. Only the records meet this condition are returned and can be used in `thicken_cust` and `pad_cust`.

```{r}
veh_acc_span <- span_time("20160331 19", "20160701 07", interval = "hour") %>% 
  subset_span(list(hour = c(7, 10, 16, 19)))
# span_time("20151210 16", "20161017 19", interval = "hour", tz = "EST") %>% 
veh_acc %>% 
  thicken_cust(veh_acc_span, "day_hour") %>% 
  count(day_hour) %>% 
  pad_cust(veh_acc_span)



```

